<!-- File path: templates/jobs_management/build_bom.html -->
{% extends "base.html" %}

{% block title %}BOM ‚Äî {{ build.name }}{% endblock %}
{% block topbar %}üìã BOM ‚Äî {{ build.name }}{% endblock %}

{% block content %}
<div class="page">

  <div class="page-header">
    <div>
      <h1 class="page-title">{{ job.job_number }} ‚Äî {{ build.name }}</h1>
      <p class="page-subtitle">Bill of Materials (components only)</p>
    </div>

    <div class="row">
      <a class="btn" href="{{ url_for('jobs_bp.job_detail', job_id=job.id) }}">‚Üê Back to Job</a>
   
      <form method="post" action="{{ url_for('jobs_bp.build_ops_regenerate', build_id=build.id) }}">
        <button class="btn" type="submit">üîÅ Regenerate Ops</button>
      </form>
   

      <span class="badge 
		{% if build.status=='queue' %}badge-queue
		{% elif build.status=='in_progress' %}badge-in-progress
		{% elif build.status=='complete' %}badge-complete
		{% endif %}">
        {{ (build.status or '').replace('_',' ') }}
      </span>
    </div>
  </div>

  <div class="card">
    <h2>Add BOM Item</h2>
    <p class="muted">Select a catalog part OR enter a free-text line (until CSV import / full catalog exists).</p>

    <form method="post" action="{{ url_for('jobs_bp.build_bom_add', build_id=build.id) }}" class="stack">
      <div class="row">
        <div class="field" style="min-width: 420px; flex: 1;">
          <label>Catalog Part</label>
          <select name="part_id">
            <option value="">‚Äî Select a part ‚Äî</option>
            {% for p in parts %}
              <option value="{{ p.id }}">{{ p.part_number }} ‚Äî {{ p.name }}</option>
            {% endfor %}
          </select>
          <div class="help">Selecting a part snapshots PN/name/unit into the BOM line.</div>
        </div>

        <div class="field" style="min-width: 140px;">
          <label>Qty per Assembly</label>
          <input type="number" name="qty" value="1" min="0" step="0.01" />
          <div class="help">Build qty ordered: {{ build.qty_ordered }}</div>
        </div>

        <form method="post" action="{{ url_for('jobs_bp.build_bom_add', build_id=build.id) }}" class="stack">
            <button class="btn btn-primary" type="submit">‚ûï Add</button>
        </form>

      </div>

      <div class="row" style="margin-top: 6px;">
        <div class="field" style="min-width: 220px;">
          <label>Free-text Part #</label>
          <input type="text" name="part_number" placeholder="Optional" />
        </div>

        <div class="field" style="min-width: 420px; flex: 1;">
          <label>Free-text Name</label>
          <input type="text" name="name" placeholder="Required if no catalog part selected" />
        </div>

        <div class="field" style="min-width: 140px;">
          <label>Unit</label>
          <input type="text" name="unit" value="ea" />
        </div>
      </div>

      <div class="row">
        <div class="field" style="flex: 1; min-width: 680px;">
          <label>Description</label>
          <input type="text" name="description" placeholder="Optional notes/spec..." />
        </div>
      </div>
    </form>
  </div>

  <div class="card">
    <h2>Current BOM</h2>

    <table class="table" style="margin-top: 12px;">
      <thead>
        <tr>
          <th style="width: 80px;">Line</th>
          <th style="width: 180px;">Part #</th>
          <th>Name</th>
          <th style="width: 120px;">Qty / Assembly</th>
          <th style="width: 120px;">Total Needed</th>
          <th style="width: 120px;">Unit</th>
          <th style="width: 120px;">Source</th>
          <th style="width: 140px;">Actions</th>
        </tr>
      </thead>
      <tbody>
        {% for item in bom_items %}
          <tr>
            <td class="muted">{{ item.line_no }}</td>
            <td style="font-weight: 900;">{{ item.part_number or "" }}</td>
            <td>{{ item.name }}</td>
            <td class="muted">{{ item.qty }}</td>
            <td class="muted">{{ (item.qty or 0) * (build.qty_ordered or 0) }}</td>
            <td class="muted">{{ item.unit }}</td>
            <td class="muted">{{ item.source }}</td>
            <td>
              <form method="post" action="{{ url_for('jobs_bp.build_bom_delete', bom_item_id=item.id) }}"
                    onsubmit="return confirm('Delete this BOM line?');">
                <button class="btn btn-danger" type="submit">Delete</button>
              </form>
            </td>
          </tr>
        {% else %}
          <tr><td colspan="7" class="muted">No BOM items yet.</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

</div>
{% endblock %}
