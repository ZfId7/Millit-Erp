<!-- File path: templates/manufacturing/dispatch.html-->

{% extends "base.html" %}
{% block title %}Dispatch | Manufacturing{% endblock %}

{% block topbar %}
üè≠ Manufacturing ‚Äî Dispatch Center
{% endblock %}

{% block toplinks %}
<div class="page-links">
  <a class="btn btn-primary" href="{{ url_for('mfg_bp.mfg_queue') }}">Queue</a>
  <a class="btn btn-primary" href="{{ url_for('mfg_bp.mfg_dispatch') }}">Dispatch</a>
  <a class="btn btn-primary" href="{{ url_for('mfg_bp.mfg_machines_index') }}">Machines</a>
</div>
{{ super() }}
{% endblock %}

{% block content %}
<div class="page">
  <div class="page-header">
    <div>
      <h1 class="page-title">Unassigned CNC Ops</h1>
      <p class="page-subtitle">V0: dispatch released <span class="badge badge-queue">queued</span> ops to a specific machine.</p>
    </div>
  </div>

  <div class="card">
    <h2>Dispatchable Operations</h2>

    {% if ops|length == 0 %}
      <p class="muted">No unassigned, released queued operations.</p>
    {% else %}
      <table class="table">
        <thead>
          <tr>
            <th>ID</th>
            <th>Build</th>
            <th>Op</th>
            <th>Seq</th>
            <th>Status</th>
            <th>Qty</th>
            <th style="width: 360px;">Assign</th>
          </tr>
        </thead>
        <tbody>
          {% for op in ops %}
          <tr>
            <td>{{ op.id }}</td>
            <td>#{{ op.build_id }}</td>
            <td>
              <div style="display:flex; flex-direction:column; gap:2px;">
                <a href="{{ url_for('mfg_bp.mfg_details', op_id=op.id) }}" style="text-decoration:none;">
                  <strong>{{ op.op_name }}</strong>
                </a>
                <span class="muted">{{ op.op_key }}</span>
              </div>
            </td>
            <td>{{ op.sequence }}</td>
            <td>
              {% if op.status == "queue" %}
                <span class="badge badge-queue">queued</span>
              {% elif op.status == "in_progress" %}
                <span class="badge badge-in-progress">in progress</span>
              {% elif op.status == "completed" %}
                <span class="badge badge-complete">complete</span>
              {% else %}
                <span class="badge">{{ op.status }}</span>
              {% endif %}
            </td>
            <td>
              <span class="muted">{{ "%.0f"|format(op.qty_done or 0) }}</span>
              /
              <strong>{{ "%.0f"|format(op.qty_planned or 0) }}</strong>
              {% if (op.qty_scrap or 0) > 0 %}
                <span class="muted">(+{{ "%.0f"|format(op.qty_scrap) }} scrap)</span>
              {% endif %}
            </td>

            <td>
              <form method="POST" action="{{ url_for('mfg_bp.mfg_dispatch_assign') }}" class="row" style="margin:0; gap:10px;">
                <input type="hidden" name="op_id" value="{{ op.id }}">

                <select name="machine_id" required style="min-width: 210px;">
                  <option value="" disabled selected>Select machine‚Ä¶</option>
                  {% for m in machines %}
                    <option value="{{ m.id }}">{{ m.name }}</option>
                  {% endfor %}
                </select>

                <button class="btn btn-primary" type="submit">Assign</button>
              </form>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    {% endif %}
  </div>

  <div class="card">
    <h2>Notes</h2>
    <p class="muted">
      V0-B behavior: ops are created as generic CNC work (<code>cnc_profile</code>) and get dispatched here.
      Later we can split eligibility rules without changing routing generation.
    </p>
  </div>
</div>
{% endblock %}
