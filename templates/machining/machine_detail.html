<!-- File path: templates/manufacturing/machine_detail.html-->

{% extends "base.html" %}
{% block title %}{{ machine.name }} | Manufacturing{% endblock %}

{% block topbar %}
üè≠ {{ machine.name }}
{% endblock %}

{% block toplinks %}
<div class="page-links">
  <a class="btn" href="{{ url_for('mfg_bp.mfg_queue') }}">Queue</a>
  <a class="btn" href="{{ url_for('mfg_bp.mfg_dispatch') }}">Dispatch</a>
  <a class="btn" href="{{ url_for('mfg_bp.mfg_machines_index') }}">Machines</a>
</div>
{{ super() }}
{% endblock %}

{% block content %}
<div class="page">
  <div class="page-header">
    <div>
      <h1 class="page-title">{{ machine.name }}</h1>
      <p class="page-subtitle">
        Key: <span class="muted">{{ machine.key }}</span> ¬∑ Group: <span class="muted">{{ machine.machine_group }}</span>
      </p>
    </div>
  </div>

  <div class="card">
    <h2>Assigned</h2>

    {% if queue.assigned|length == 0 %}
      <p class="muted">Nothing assigned to this machine.</p>
    {% else %}
      <table class="table">
        <thead>
          <tr>
            <th>ID</th>
            <th>Op</th>
            <th>Status</th>
            <th>Qty</th>
            <th></th>
          </tr>
        </thead>
        <tbody>
        {% for op in queue.assigned %}
          <tr>
            <td>{{ op.id }}</td>
            <td>
              <a href="{{ url_for('mfg_bp.mfg_details', op_id=op.id) }}" style="text-decoration:none;">
                <strong>{{ op.op_name }}</strong>
              </a>
              <div class="muted">{{ op.op_key }}</div>
            </td>
            <td>
              {% if op.status == "queue" %}
                <span class="badge badge-queue">queued</span>
              {% elif op.status == "in_progress" %}
                <span class="badge badge-in-progress">in progress</span>
              {% elif op.status == "completed" %}
                <span class="badge badge-complete">complete</span>
              {% else %}
                <span class="badge">{{ op.status }}</span>
              {% endif %}
            </td>
            <td>
              <span class="muted">{{ "%.0f"|format(op.qty_done or 0) }}</span> /
              <strong>{{ "%.0f"|format(op.qty_planned or 0) }}</strong>
            </td>
            <td style="text-align:right;">
              {% if op.status == "queue" %}
              <form method="POST" action="{{ url_for('mfg_bp.mfg_machine_release', machine_id=machine.id, op_id=op.id) }}" style="display:inline;">
                <button class="btn" type="submit">Release</button>
              </form>
              {% else %}
                <span class="muted">Locked</span>
              {% endif %}
            </td>
          </tr>
        {% endfor %}
        </tbody>
      </table>
    {% endif %}
  </div>

  <div class="card">
    <h2>Eligible Unassigned</h2>

    {% if queue.eligible_unassigned|length == 0 %}
      <p class="muted">No eligible unassigned queued ops.</p>
    {% else %}
      <table class="table">
        <thead>
          <tr>
            <th>ID</th>
            <th>Op</th>
            <th>Seq</th>
            <th>Qty</th>
            <th></th>
          </tr>
        </thead>
        <tbody>
        {% for op in queue.eligible_unassigned %}
          <tr>
            <td>{{ op.id }}</td>
            <td>
              <a href="{{ url_for('mfg_bp.mfg_details', op_id=op.id) }}" style="text-decoration:none;">
                <strong>{{ op.op_name }}</strong>
              </a>
              <div class="muted">{{ op.op_key }}</div>
            </td>
            <td>{{ op.sequence }}</td>
            <td>
              <span class="muted">{{ "%.0f"|format(op.qty_done or 0) }}</span> /
              <strong>{{ "%.0f"|format(op.qty_planned or 0) }}</strong>
            </td>
            <td style="text-align:right;">
              <form method="POST" action="{{ url_for('mfg_bp.mfg_machine_claim', machine_id=machine.id, op_id=op.id) }}" style="display:inline;">
                <button class="btn btn-primary" type="submit">Claim</button>
              </form>
            </td>
          </tr>
        {% endfor %}
        </tbody>
      </table>
    {% endif %}
  </div>
</div>
{% endblock %}
