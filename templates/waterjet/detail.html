<!-- File path: templates/waterjet/detail.html -->
<!-- V1 Read only Waterjet Detail -->

{% extends "base.html" %}
{% block title %}Waterjet Details{% endblock %}
{% block topbar %}ğŸ’§ Waterjet â€” Details{% endblock %}

{% block content %}
<div class="page">
  <div class="page-header">
    <div>
      <h1 class="page-title">Waterjet Details</h1>
      <p class="page-subtitle">
        Job #{{ op.build.job.job_number if op.build and op.build.job else "" }} â€”
        {{ op.build.job.customer.name if op.build and op.build.job and op.build.job.customer else "" }}
      </p>
    </div>

    <div style="display:flex; gap:10px; align-items:center;">
      <a href="{{ url_for('waterjet_bp.waterjet_queue') }}" class="btn btn-secondary">â† Back to Queue</a>

      <a href="{{ url_for('waterjet_bp.waterjet_detail_edit', op_id=op.id) }}" class="btn btn-primary">
        Edit Details
      </a>

      <span class="badge
        {% if op.status == 'queue' %}badge-queue
        {% elif op.status == 'in_progress' %}badge-in-progress
        {% elif op.status == 'blocked' %}badge-warning
        {% elif op.status == 'completed' %}badge-complete
        {% elif op.status == 'cancelled' %}badge-danger
        {% endif %}">
        {{ op.status.replace('_', ' ') }}
      </span>
    </div>
  </div>

  <!-- Status actions stay usable -->
  <div class="card" style="margin-bottom: 12px;">
    <div style="display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end;">
      {% if op.status == 'cancelled' %}
        <form method="POST" action="{{ url_for('waterjet_bp.waterjet_reopen', op_id=op.id) }}">
          <button class="btn btn-secondary" type="submit">Reopen</button>
        </form>
      {% endif %}

      <form method="POST" action="{{ url_for('waterjet_bp.waterjet_start', op_id=op.id) }}">
        <button class="btn" type="submit">Start</button>
      </form>

      <form method="POST" action="{{ url_for('waterjet_bp.waterjet_complete', op_id=op.id) }}">
        <button class="btn btn-success" type="submit">Complete</button>
      </form>

      <form method="POST" action="{{ url_for('waterjet_bp.waterjet_cancel', op_id=op.id) }}">
        <button class="btn btn-danger" type="submit">Cancel</button>
      </form>

      
    </div>
  </div>

  <!-- Read-only cards -->
  <div class="card" style="margin-bottom: 12px;">
    <h2 style="margin-top:0;">Material</h2>
    <div class="muted" style="margin-bottom:10px;">
      Raw Stock: <strong>{{ detail.raw_stock.name if detail.raw_stock else "â€”" }}</strong>
      {% if detail.raw_stock and detail.raw_stock.material_type %} ({{ detail.raw_stock.material_type }}){% endif %}
    </div>

    <div class="row" style="gap:12px; flex-wrap:wrap;">
      <div style="min-width:220px;">
        <div class="muted" style="font-size:12px;">Thickness</div>
        <div style="font-weight:700;">
          {% if detail.thickness_override is not none %}
            {{ "%.4f"|format(detail.thickness_override) }}"
            <span class="muted">(override)</span>
          {% elif detail.raw_stock and detail.raw_stock.thickness_in is not none %}
            {{ "%.4f"|format(detail.raw_stock.thickness_in) }}"
          {% else %}â€”{% endif %}
        </div>
      </div>

      <div style="min-width:220px;">
        <div class="muted" style="font-size:12px;">Size</div>
        <div style="font-weight:700;">
          {% set w = detail.width_override if detail.width_override is not none else (detail.raw_stock.width_in if detail.raw_stock else none) %}
          {% set l = detail.length_override if detail.length_override is not none else (detail.raw_stock.length_in if detail.raw_stock else none) %}
          {% if w is not none and l is not none %}
            {{ "%.2f"|format(w) }}" Ã— {{ "%.2f"|format(l) }}"
          {% else %}â€”{% endif %}
        </div>
      </div>

      <div style="min-width:220px;">
        <div class="muted" style="font-size:12px;">Source</div>
        <div style="font-weight:700;">{{ detail.material_source or "â€”" }}</div>
      </div>

      <div style="min-width:260px; flex:1;">
        <div class="muted" style="font-size:12px;">Yield</div>
        <div style="font-weight:700;">{{ detail.yield_note or "â€”" }}</div>
      </div>
    </div>
  </div>

  <div class="card" style="margin-bottom: 12px;">
    <h2 style="margin-top:0;">Program / File</h2>
    <div class="row" style="gap:12px; flex-wrap:wrap;">
      <div style="min-width:320px; flex:1;">
        <div class="muted" style="font-size:12px;">File name</div>
        <div style="font-weight:700;">{{ detail.file_name or "â€”" }}</div>
      </div>
      <div style="min-width:220px;">
        <div class="muted" style="font-size:12px;">Revision</div>
        <div style="font-weight:700;">{{ detail.program_revision or "â€”" }}</div>
      </div>
    </div>
  </div>

  <div class="card" style="margin-bottom: 12px;">
    <h2 style="margin-top:0;">Runtime</h2>
    <div class="row" style="gap:12px; flex-wrap:wrap;">
      <div style="min-width:220px;">
        <div class="muted" style="font-size:12px;">Estimated (min)</div>
        <div style="font-weight:700;">{{ detail.runtime_est_min if detail.runtime_est_min is not none else "â€”" }}</div>
      </div>
      <div style="min-width:220px;">
        <div class="muted" style="font-size:12px;">Actual (min)</div>
        <div style="font-weight:700;">{{ detail.runtime_actual_min if detail.runtime_actual_min is not none else "â€”" }}</div>
      </div>
    </div>
  </div>

  <div class="card">
    <h2 style="margin-top:0;">Notes</h2>
    <div class="muted" style="white-space: pre-wrap;">{{ detail.notes or "â€”" }}</div>
  </div>
  
  <div class="card" style="margin-bottom: 12px;">
      <h2 style="margin-top:0;">Blocked Status</h2>

      {% if op.status == 'blocked' %}
        <div class="row" style="gap:12px; flex-wrap:wrap;">
          <div style="min-width:240px;">
            <div class="muted" style="font-size:12px;">Blocked Reason</div>
            <div style="font-weight:700;">
              {{ detail.blocked_reason.replace('_', ' ') if detail.blocked_reason else 'â€”' }}
            </div>
          </div>

          <div style="min-width:320px; flex:1;">
            <div class="muted" style="font-size:12px;">Blocked Notes</div>
            <div style="font-weight:700; white-space:pre-wrap;">
              {{ detail.blocked_notes or 'â€”' }}
            </div>
          </div>
        </div>

      {% else %}
        <div class="muted">Operation is not blocked.</div>
      {% endif %}
    </div>

</div>
{% endblock %}
