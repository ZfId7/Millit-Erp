<!-- File path: templates/manufacturing/details.html -->
<!-- V1 Manufacturing Op Details -->

{% extends "base.html" %}


{% block title %}Manufacturing Op Details{% endblock %}
{% block topbar %}üè≠ Manufacturing ¬∑ Operation Details{% endblock %}
{% block toplinks %}
    <span class="page-links">
      <a class="btn btn-secondary" href="{{ url_for('mfg_bp.mfg_queue') }}">‚Üê Back to Queue</a>
      <a class="btn btn-primary" href="{{ url_for('mfg_bp.mfg_index') }}">Manufacturing Home</a> 

    
    </span>
      {{ super() }}
{% endblock %}

{% block content %}
<div class="page">

  <div class="page-header">
    <div>
      <h1 class="page-title">Operation Details</h1>
      <p class="page-subtitle">
        Concrete queued operation instance generated from BOM routing (BuildOperation).
      </p>
    </div>
  </div>

  <!-- Summary / Context -->
  <div class="card">
    <h2>Context</h2>

    <div class="row" style="gap: 18px;">
      <div class="stack" style="min-width: 280px;">
        <div class="muted">Job</div>
        {% if op.build and op.build.job %}
          <div style="font-weight:900;">
            {{ op.build.job.job_number }}
          </div>
          <div class="muted">{{ op.build.job.title }}</div>
          <div style="margin-top:8px;">
            <a class="btn btn-sm btn-secondary"
               href="{{ url_for('jobs_bp.job_daily_update', job_id=op.build.job.id, _anchor='op-' ~ op.id) }}">
              Open Job
            </a>
          </div>
        {% else %}
          <div class="muted">No job linked.</div>
        {% endif %}
      </div>

      <div class="stack" style="min-width: 320px;">
        <div class="muted">Build</div>
        {% if op.build %}
          <div style="font-weight:900;">
            {{ op.build.display_name if op.build.display_name else ('Build #' ~ op.build.id) }}
          </div>
          <div class="muted">Build ID: {{ op.build.id }}</div>
        {% else %}
          <div class="muted">No build linked.</div>
        {% endif %}
      </div>

      <div class="stack" style="min-width: 360px; flex: 1;">
        <div class="muted">Component (BOM Item)</div>
        {% if op.bom_item and op.bom_item.part %}
          <div style="font-weight:900;">{{ op.bom_item.part.part_number }}</div>
          <div class="muted">{{ op.bom_item.part.name }}</div>
          {% if op.bom_item.qty is not none %}
            <div class="muted">BOM Qty: {{ op.bom_item.qty }}</div>
          {% endif %}
        {% elif op.bom_item %}
          <div class="muted">BOM item linked (no part record).</div>
        {% else %}
          <div class="muted">(No BOM item linked)</div>
        {% endif %}
      </div>
    </div>
  </div>

  <!-- Operation info + actions -->
  <div class="card">
    <div class="row" style="justify-content: space-between; align-items: center;">
      <h2 style="margin:0;">Operation</h2>

      <div class="row" style="gap: 8px; align-items: center;">
        {% set s = (op.status or '') %}
        <span class="badge
          {% if s == 'queue' %}badge-queue
          {% elif s == 'in_progress' %}badge-in-progress
          {% elif s == 'blocked' %}badge-blocked
          {% elif s == 'cancelled' %}badge-cancelled
          {% elif s == 'complete' %}badge-complete
          {% endif %}">
          {{ s.replace('_',' ') }}
        </span>

        {% if op.is_released is not none %}
          {% if op.is_released %}
            <span class="badge badge-complete" style="border-color: rgba(0,191,255,.25); background: rgba(0,191,255,.08); color: var(--accent-2);">
              released
            </span>
          {% else %}
            <span class="badge">not released</span>
          {% endif %}
        {% endif %}
      </div>
    </div>

    <div class="row" style="margin-top: 10px; gap: 18px;">
      <div class="stack" style="min-width: 260px;">
        <div class="muted">Name</div>
        <div style="font-weight:900;">{{ op.op_name }}</div>
        <div class="muted">op_key: {{ op.op_key }}</div>
      </div>

      <div class="stack" style="min-width: 220px;">
        <div class="muted">Module</div>
        <div style="font-weight:900;">{{ op.module_key }}</div>
        <div class="muted">sequence: {{ op.sequence }}</div>
      </div>

      <div class="stack" style="min-width: 260px;">
        <div class="muted">Dispatch (Machine)</div>
        {% if op.assigned_machine %}
          <div style="font-weight:900;">{{ op.assigned_machine.name }}</div>
          <div class="muted">{{ op.assigned_machine.machine_group }}</div>
        {% else %}
          <div class="muted">Unassigned</div>
        {% endif %}
        <div class="muted" style="margin-top:6px;">
          (Assign from Queue for now)
        </div>
      </div>

      <div class="stack" style="min-width: 220px;">
        <div class="muted">Created</div>
        {% if op.created_at %}
          <div style="font-weight:900;">{{ op.created_at }}</div>
        {% else %}
          <div class="muted">‚Äî</div>
        {% endif %}
      </div>
    </div>

    <div class="row" style="margin-top: 14px; gap: 10px; align-items:center;">
      {% if op.status not in ['complete', 'cancelled'] %}

        {% if op.status == 'queue' %}
          <form method="post" action="{{ url_for('mfg_bp.mfg_start', op_id=op.id) }}">
            <button class="btn" type="submit">Start</button>
          </form>
        {% endif %}

        {% if op.status in ['queue', 'in_progress'] %}
          <form method="post" action="{{ url_for('mfg_bp.mfg_block', op_id=op.id) }}">
            <button class="btn btn-secondary" type="submit">Block</button>
          </form>
        {% endif %}

        {% if op.status in ['in_progress', 'blocked'] %}
          <form method="post" action="{{ url_for('mfg_bp.mfg_complete', op_id=op.id) }}">
            <button class="btn btn-primary" type="submit">Complete</button>
          </form>
        {% endif %}

      {% else %}
        <span class="muted">No actions available.</span>
      {% endif %}
    </div>
  </div>

  <!-- Quantities + Notes -->
  <div class="card">
    <h2>Quantities</h2>

    <div class="row" style="gap:18px;">
      <div class="stack" style="min-width: 180px;">
        <div class="muted">Planned</div>
        <div style="font-weight:900;">{{ op.qty_planned }}</div>
      </div>

      <div class="stack" style="min-width: 180px;">
        <div class="muted">Done</div>
        <div style="font-weight:900;">{{ totals.qty_done }}</div>
      </div>

      <div class="stack" style="min-width: 180px;">
        <div class="muted">Scrap</div>
        <div style="font-weight:900;">{{ totals.qty_scrap }}</div>
      </div>

      <div class="stack" style="min-width: 220px;">
        <div class="muted">Outsourced</div>
        <div style="font-weight:900;">{{ 'Yes' if op.is_outsourced else 'No' }}</div>
        {% if op.vendor %}
          <div class="muted">Vendor: {{ op.vendor }}</div>
        {% endif %}
      </div>
    </div>

    <div style="margin-top: 14px;">
      <div class="muted" style="margin-bottom:6px;">Notes</div>
      <div class="card" style="background: rgba(255,255,255,.02); border-radius: 10px;">
        {% if op.notes %}
          <div style="white-space: pre-wrap;">{{ op.notes }}</div>
        {% else %}
          <div class="muted">No notes.</div>
        {% endif %}
      </div>

      <div class="muted" style="margin-top:8px;">
        (V1: notes are read-only here. We can add ‚Äúedit notes‚Äù + ‚Äúadd progress log‚Äù next.)
      </div>
    </div>
  </div>
  
  <div class="card">
      <h2>Progress Updates</h2>

      <form method="POST" action="{{ url_for('mfg_bp.mfg_progress_add', op_id=op.id) }}"
            style="display:flex; gap:10px; flex-wrap:wrap; align-items:flex-end;">

        <div style="min-width:160px;">
          <div class="muted">Qty Done (delta)</div>
          <input class="input" type="number" step="0.0001" min="0" name="qty_done_delta" value="0">
        </div>

        <div style="min-width:160px;">
          <div class="muted">Qty Scrap (delta)</div>
          <input class="input" type="number" step="0.0001" min="0" name="qty_scrap_delta" value="0">
        </div>

        <div style="flex:1; min-width:260px;">
          <div class="muted">Note</div>
          <input class="input" type="text" name="note" placeholder="Optional note‚Ä¶">
        </div>

        <button class="btn btn-primary" type="submit">Add Update</button>
      </form>

      <div style="margin-top:14px;">
        <div class="muted" style="margin-bottom:6px;">
          Ledger totals: <strong>{{ totals.qty_done }}</strong> done,
          <strong>{{ totals.qty_scrap }}</strong> scrap
          {% if op.qty_planned is not none %}
            ¬∑ Planned: <strong>{{ op.qty_planned }}</strong>
            ¬∑ Remaining: <strong>{{ (op.qty_planned - totals.qty_done - totals.qty_scrap) }}</strong>
          {% endif %}
        </div>

        {% if progress_updates %}
          <table class="table">
            <thead>
              <tr>
                <th>Time</th>
                <th>Done Œî</th>
                <th>Scrap Œî</th>
                <th>Note</th>
              </tr>
            </thead>
            <tbody>
              {% for u in progress_updates %}
                <tr>
                  <td class="muted">{{ u.created_at }}</td>
                  <td>{{ u.qty_done_delta }}</td>
                  <td>{{ u.qty_scrap_delta }}</td>
                  <td>{{ u.note or '' }}</td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        {% else %}
          <div class="muted">No progress updates yet.</div>
        {% endif %}
      </div>
  </div>

</div>
{% endblock %}
